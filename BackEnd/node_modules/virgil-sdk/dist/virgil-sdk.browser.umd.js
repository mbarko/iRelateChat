!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).Virgil={})}(this,(function(t){"use strict";var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(t,e){return t(e={exports:{}},e.exports),e.exports}var n=r((function(t,r){!function(n){var i=r,o=t&&t.exports==i&&t,s="object"==typeof e&&e;s.global!==s&&s.window!==s||(n=s);var a=function(t){this.message=t};(a.prototype=new Error).name="InvalidCharacterError";var u=function(t){throw new a(t)},c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d=/[\t\n\f\r ]/g,f={encode:function(t){t=String(t),/[^\0-\xFF]/.test(t)&&u("The string to be encoded contains characters outside of the Latin1 range.");for(var e,r,n,i,o=t.length%3,s="",a=-1,d=t.length-o;++a<d;)e=t.charCodeAt(a)<<16,r=t.charCodeAt(++a)<<8,n=t.charCodeAt(++a),s+=c.charAt((i=e+r+n)>>18&63)+c.charAt(i>>12&63)+c.charAt(i>>6&63)+c.charAt(63&i);return 2==o?(e=t.charCodeAt(a)<<8,r=t.charCodeAt(++a),s+=c.charAt((i=e+r)>>10)+c.charAt(i>>4&63)+c.charAt(i<<2&63)+"="):1==o&&(i=t.charCodeAt(a),s+=c.charAt(i>>2)+c.charAt(i<<4&63)+"=="),s},decode:function(t){var e=(t=String(t).replace(d,"")).length;e%4==0&&(e=(t=t.replace(/==?$/,"")).length),(e%4==1||/[^+a-zA-Z0-9/]/.test(t))&&u("Invalid character: the string to be decoded is not correctly encoded.");for(var r,n,i=0,o="",s=-1;++s<e;)n=c.indexOf(t.charAt(s)),r=i%4?64*r+n:n,i++%4&&(o+=String.fromCharCode(255&r>>(-2*i&6)));return o},version:"0.1.0"};if(i&&!i.nodeType)if(o)o.exports=f;else for(var h in f)f.hasOwnProperty(h)&&(i[h]=f[h]);else n.base64=f}(e)}));function i(t){return n.decode(t)}function o(t){return n.encode(t)}function s(t){return t=(t=t.split("=")[0]).replace(/\+/g,"-").replace(/\//g,"_")}function a(t){switch((t=t.replace(/-/g,"+").replace(/_/g,"/")).length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("Invalid base64 string")}return t}function u(t){return s(o(t))}function c(t){return i(a(t))}function d(t){var e;return e="number"==typeof t?t:t.getTime(),Math.floor(e/1e3)}var f=function(){function t(t,e,r){if("string"==typeof t){var n=t,i=n.split(".");if(3!==i.length)throw new Error("Wrong JWT format");try{this.header=JSON.parse(c(i[0])),this.body=JSON.parse(c(i[1])),this.signature=a(i[2])}catch(t){throw new Error("Wrong JWT format")}this.unsignedData=i[0]+"."+i[1],this.stringRepresentation=n}else{if("object"!=typeof t||"object"!=typeof e)throw new TypeError("Invalid arguments for function Jwt. Expected a string representation of a token, or header and body as objects");this.header=t,this.body=e,this.signature=r,this.unsignedData=this.headerBase64()+"."+this.bodyBase64(),this.stringRepresentation=null==this.signature?this.unsignedData:this.unsignedData+"."+this.signatureBase64()}}return t.fromString=function(e){return new t(e)},t.prototype.toString=function(){return this.stringRepresentation},t.prototype.identity=function(){if(0!==this.body.sub.indexOf("identity-"))throw new Error("wrong sub format");return this.body.sub.substr("identity-".length)},t.prototype.appId=function(){if(0!==this.body.iss.indexOf("virgil-"))throw new Error("wrong iss format");return this.body.iss.substr("virgil-".length)},t.prototype.isExpired=function(t){void 0===t&&(t=new Date);var e=d(t);return this.body.exp<e},t.prototype.headerBase64=function(){return u(JSON.stringify(this.header))},t.prototype.bodyBase64=function(){return u(JSON.stringify(this.body))},t.prototype.signatureBase64=function(){return s(this.signature)},t}();function h(t,e){if(!t)throw new Error(e)}var p=function(){function t(t){var e,r;r=function(t){return"Invalid JwtGenerator options. `"+t+"` is required"},h(null!=(e=t),"JwtGenerator options must be provided"),h(null!=e.apiKey,r("apiKey")),h(null!=e.apiKeyId,r("apiKeyId")),h(null!=e.appId,r("appId")),h(null!=e.accessTokenSigner,r("accessTokenSigner")),this.appId=t.appId,this.apiKey=t.apiKey,this.apiKeyId=t.apiKeyId,this.accessTokenSigner=t.accessTokenSigner,this.millisecondsToLive=void 0!==t.millisecondsToLive?Number(t.millisecondsToLive):12e5}return t.prototype.generateToken=function(t,e){if(!t)throw new TypeError("Illegal arguments for function `generateToken`. Argument `identity` is required.");var r=d(new Date),n=d((new Date).getTime()+this.millisecondsToLive),i={iss:"virgil-"+this.appId,sub:"identity-"+t,iat:r,exp:n,ada:e},o={alg:this.accessTokenSigner.getAlgorithm(),kid:this.apiKeyId,typ:"JWT",cty:"virgil-jwt;v=1"},s=new f(o,i),a=this.accessTokenSigner.generateTokenSignature({value:s.unsignedData,encoding:"utf8"},this.apiKey);return new f(o,i,a.toString("base64"))},t}();var l=function(){function t(t){var e,r;r=function(t){return"Invalid JwtVerifier options. `"+t+"` is required"},h(null!=(e=t),"JwtVerifier options must be provided"),h(null!=e.apiPublicKey,r("apiPublicKey")),h(null!=e.apiKeyId,r("apiKeyId")),h(null!=e.accessTokenSigner,r("accessTokenSigner")),this.accessTokenSigner=t.accessTokenSigner,this.apiPublicKey=t.apiPublicKey,this.apiKeyId=t.apiKeyId}return t.prototype.verifyToken=function(t){if(null==t)throw new Error("Token is empty");return!!this.allFieldsAreCorrect(t)&&this.accessTokenSigner.verifyTokenSignature({value:t.unsignedData,encoding:"utf8"},{value:t.signature,encoding:"base64"},this.apiPublicKey)},t.prototype.allFieldsAreCorrect=function(t){return t.header.kid==this.apiKeyId&&t.header.alg==this.accessTokenSigner.getAlgorithm()&&"virgil-jwt;v=1"==t.header.cty&&"JWT"==t.header.typ},t}();var y=function(){function t(t,e){var r=this;if("function"!=typeof t)throw new TypeError("`renewJwtFn` must be a function");if(e){var n=void 0;if("string"==typeof e)n=f.fromString(e);else{if(!(e instanceof f))throw new Error('Expected "initialToken" to be a string or an instance of Jwt, got '+typeof e);n=e}this.cachedJwt=n}this.getJwt=function(e){return r.cachedJwt&&!r.cachedJwt.isExpired((n=new Date,i=5,"number"==typeof n?new Date(n+1e3*i):new Date(n.getTime()+1e3*i)))?Promise.resolve(r.cachedJwt):(r.jwtPromise||(r.jwtPromise=Promise.resolve(t(e)).then((function(t){var e="string"==typeof t?f.fromString(t):t;return r.cachedJwt=e,r.jwtPromise=void 0,e})).catch((function(t){throw r.jwtPromise=void 0,t}))),r.jwtPromise);var n,i}}return t.prototype.getToken=function(t){return this.getJwt(t)},t}(),v=function(){function t(t){if("function"!=typeof t)throw new TypeError("`getJwtFn` must be a function");this.getJwt=function(e){return Promise.resolve(t(e)).then((function(t){return"string"==typeof t?f.fromString(t):t}))}}return t.prototype.getToken=function(t){return this.getJwt(t)},t}(),g=function(){function t(t){if(this.accessToken=t,null==t)throw new TypeError("`accessToken` is required")}return t.prototype.getToken=function(t){return Promise.resolve(this.accessToken)},t}(),w=function(){function t(t,e,r){if(this.jwtGenerator=t,this.additionalData=e,this.defaultIdentity=r,null==t)throw new TypeError("`jwtGenerator` is required")}return t.prototype.getToken=function(t){var e=this;return Promise.resolve().then((function(){return e.jwtGenerator.generateToken(t.identity||e.defaultIdentity||"",e.additionalData)}))},t}(),b=function(t,e){return(b=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function m(t,e){function r(){this.constructor=t}b(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var S=function(){return(S=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function E(t,e){var r={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(r[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(t);i<n.length;i++)e.indexOf(n[i])<0&&(r[n[i]]=t[n[i]])}return r}function T(t,e,r,n){return new(r||(r=Promise))((function(i,o){function s(t){try{u(n.next(t))}catch(t){o(t)}}function a(t){try{u(n.throw(t))}catch(t){o(t)}}function u(t){t.done?i(t.value):new r((function(e){e(t.value)})).then(s,a)}u((n=n.apply(t,e||[])).next())}))}function x(t,e){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var A,C=function(){function t(t,e){this.contentSnapshot=t,this.signatures=e}return t.fromString=function(e){var r,n=i(e);try{r=JSON.parse(n)}catch(t){throw new Error("The string to be parsed is in invalid format")}return t.fromJson(r)},t.fromJson=function(e){return new t(i(e.content_snapshot),(e.signatures||[]).map((function(t){var e=t.signer,r=t.signature,n=t.snapshot;return n?{signer:e,signature:r,snapshot:i(n)}:{signer:e,signature:r}})))},t.prototype.toJSON=function(){return this.toJson()},t.prototype.toJson=function(){return{content_snapshot:o(this.contentSnapshot),signatures:this.signatures.map((function(t){var e=t.signer,r=t.signature,n=t.snapshot;return n?{signer:e,signature:r,snapshot:o(n)}:{signer:e,signature:r}}))}},t.prototype.toString=function(){return o(JSON.stringify(this))},t.prototype.exportAsJson=function(){return this.toJson()},t.prototype.exportAsString=function(){return this.toString()},t}(),k=r((function(t,r){!function(e){t.exports=function(t){var r=t&&t.Promise||e.Promise,n=t&&t.XMLHttpRequest||e.XMLHttpRequest,i=e;return function(){var t=Object.create(i,{fetch:{value:void 0,writable:!0}});return function(t){if(!t.fetch){var e="URLSearchParams"in t,i="Symbol"in t&&"iterator"in Symbol,o="FileReader"in t&&"Blob"in t&&function(){try{return new Blob,!0}catch(t){return!1}}(),s="FormData"in t,a="ArrayBuffer"in t;if(a)var u=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],c=function(t){return t&&DataView.prototype.isPrototypeOf(t)},d=ArrayBuffer.isView||function(t){return t&&u.indexOf(Object.prototype.toString.call(t))>-1};v.prototype.append=function(t,e){t=p(t),e=l(e);var r=this.map[t];this.map[t]=r?r+","+e:e},v.prototype.delete=function(t){delete this.map[p(t)]},v.prototype.get=function(t){return t=p(t),this.has(t)?this.map[t]:null},v.prototype.has=function(t){return this.map.hasOwnProperty(p(t))},v.prototype.set=function(t,e){this.map[p(t)]=l(e)},v.prototype.forEach=function(t,e){for(var r in this.map)this.map.hasOwnProperty(r)&&t.call(e,this.map[r],r,this)},v.prototype.keys=function(){var t=[];return this.forEach((function(e,r){t.push(r)})),y(t)},v.prototype.values=function(){var t=[];return this.forEach((function(e){t.push(e)})),y(t)},v.prototype.entries=function(){var t=[];return this.forEach((function(e,r){t.push([r,e])})),y(t)},i&&(v.prototype[Symbol.iterator]=v.prototype.entries);var f=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];E.prototype.clone=function(){return new E(this,{body:this._bodyInit})},S.call(E.prototype),S.call(x.prototype),x.prototype.clone=function(){return new x(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new v(this.headers),url:this.url})},x.error=function(){var t=new x(null,{status:0,statusText:""});return t.type="error",t};var h=[301,302,303,307,308];x.redirect=function(t,e){if(-1===h.indexOf(e))throw new RangeError("Invalid status code");return new x(null,{status:e,headers:{location:t}})},t.Headers=v,t.Request=E,t.Response=x,t.fetch=function(t,e){return new r((function(r,i){var s=new E(t,e),a=new n;a.onload=function(){var t,e,n={status:a.status,statusText:a.statusText,headers:(t=a.getAllResponseHeaders()||"",e=new v,t.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach((function(t){var r=t.split(":"),n=r.shift().trim();if(n){var i=r.join(":").trim();e.append(n,i)}})),e)};n.url="responseURL"in a?a.responseURL:n.headers.get("X-Request-URL");var i="response"in a?a.response:a.responseText;r(new x(i,n))},a.onerror=function(){i(new TypeError("Network request failed"))},a.ontimeout=function(){i(new TypeError("Network request failed"))},a.open(s.method,s.url,!0),"include"===s.credentials?a.withCredentials=!0:"omit"===s.credentials&&(a.withCredentials=!1),"responseType"in a&&o&&(a.responseType="blob"),s.headers.forEach((function(t,e){a.setRequestHeader(e,t)})),a.send(void 0===s._bodyInit?null:s._bodyInit)}))},t.fetch.polyfill=!0}function p(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function l(t){return"string"!=typeof t&&(t=String(t)),t}function y(t){var e={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return i&&(e[Symbol.iterator]=function(){return e}),e}function v(t){this.map={},t instanceof v?t.forEach((function(t,e){this.append(e,t)}),this):Array.isArray(t)?t.forEach((function(t){this.append(t[0],t[1])}),this):t&&Object.getOwnPropertyNames(t).forEach((function(e){this.append(e,t[e])}),this)}function g(t){if(t.bodyUsed)return r.reject(new TypeError("Already read"));t.bodyUsed=!0}function w(t){return new r((function(e,r){t.onload=function(){e(t.result)},t.onerror=function(){r(t.error)}}))}function b(t){var e=new FileReader,r=w(e);return e.readAsArrayBuffer(t),r}function m(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function S(){return this.bodyUsed=!1,this._initBody=function(t){if(this._bodyInit=t,t)if("string"==typeof t)this._bodyText=t;else if(o&&Blob.prototype.isPrototypeOf(t))this._bodyBlob=t;else if(s&&FormData.prototype.isPrototypeOf(t))this._bodyFormData=t;else if(e&&URLSearchParams.prototype.isPrototypeOf(t))this._bodyText=t.toString();else if(a&&o&&c(t))this._bodyArrayBuffer=m(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer]);else{if(!a||!ArrayBuffer.prototype.isPrototypeOf(t)&&!d(t))throw new Error("unsupported BodyInit type");this._bodyArrayBuffer=m(t)}else this._bodyText="";this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):e&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},o&&(this.blob=function(){var t=g(this);if(t)return t;if(this._bodyBlob)return r.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return r.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return r.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?g(this)||r.resolve(this._bodyArrayBuffer):this.blob().then(b)}),this.text=function(){var t,e,n,i=g(this);if(i)return i;if(this._bodyBlob)return t=this._bodyBlob,e=new FileReader,n=w(e),e.readAsText(t),n;if(this._bodyArrayBuffer)return r.resolve(function(t){for(var e=new Uint8Array(t),r=new Array(e.length),n=0;n<e.length;n++)r[n]=String.fromCharCode(e[n]);return r.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return r.resolve(this._bodyText)},s&&(this.formData=function(){return this.text().then(T)}),this.json=function(){return this.text().then(JSON.parse)},this}function E(t,e){var r,n,i=(e=e||{}).body;if(t instanceof E){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new v(t.headers)),this.method=t.method,this.mode=t.mode,i||null==t._bodyInit||(i=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=e.credentials||this.credentials||"omit",!e.headers&&this.headers||(this.headers=new v(e.headers)),this.method=(r=e.method||this.method||"GET",n=r.toUpperCase(),f.indexOf(n)>-1?n:r),this.mode=e.mode||this.mode||null,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&i)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(i)}function T(t){var e=new FormData;return t.trim().split("&").forEach((function(t){if(t){var r=t.split("="),n=r.shift().replace(/\+/g," "),i=r.join("=").replace(/\+/g," ");e.append(decodeURIComponent(n),decodeURIComponent(i))}})),e}function x(t,e){e||(e={}),this.type="default",this.status=void 0===e.status?200:e.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in e?e.statusText:"OK",this.headers=new v(e.headers),this.url=e.url||"",this._initBody(t)}}(void 0!==t?t:this),{fetch:t.fetch,Headers:t.Headers,Request:t.Request,Response:t.Response}}()}}("undefined"!=typeof self?self:e)}))(),P=k.fetch,I=(k.Request,k.Response,k.Headers),_=[{name:"Windows Phone",test:[/windows phone/i]},{test:[/windows/i],name:"Windows"},{test:[/macintosh/i],name:"macOS"},{test:[/(ipod|iphone|ipad)/i],name:"iOS"},{test:[/android/i],name:"Android"},{test:[/linux/i],name:"Linux"},{test:[/CrOS/],name:"Chrome OS"},{test:[/PlayStation 4/],name:"PlayStation 4"}],O=[{test:[/googlebot/i],name:"Googlebot"},{test:[/opera/i,/opr\/|opios/i],name:"Opera"},{test:[/msie|trident/i],name:"Internet Explorer"},{test:[/\sedg/i],name:"Microsoft Edge"},{test:[/firefox|iceweasel|fxios/i],name:"Firefox"},{test:[/chromium/i],name:"Chromium"},{test:[/chrome|crios|crmo/i],name:"Chrome"},{test:[/android/i],name:"Android Browser"},{test:[/playstation 4/i],name:"PlayStation 4"},{test:[/safari|applewebkit/i],name:"Safari"}],j=function(){function t(t,e,r){var n=this;this.isIonic=function(){return"undefined"!=typeof window&&!!("cordova"in window||"phonegap"in window||"PhoneGap"in window)&&/android|ios|iphone|ipod|ipad|iemobile/i.test(n.userAgent)},this.userAgent=r||this.getUserAgent(),this.value=t+";js;"+this.getHeaderValue()+";"+e}return t.prototype.getUserAgent=function(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""},t.prototype.getOsName=function(){var t=this,e=_.find((function(e){return e.test.some((function(e){return e.test(t.userAgent)}))}));return e?e.name:"other"},t.prototype.getBrowser=function(){var t=this,e=O.find((function(e){return e.test.some((function(e){return e.test(t.userAgent)}))}));return e?e.name:"other"},t.prototype.isReactNative=function(){return"object"==typeof navigator&&"ReactNative"===navigator.product},t.prototype.getHeaderValue=function(){try{return this.isReactNative()?"ReactNative":this.isIonic()?"Ionic/"+this.getOsName():this.getBrowser()+"/"+this.getOsName()}catch(t){return"Unknown"}},t}(),K=function(){function t(t,e){this.prefix=t,e||(e={product:"sdk",version:"6.1.0"}),this.virgilAgentValue=new j(e.product,e.version).value}return t.prototype.get=function(t,e){var r=this.createHeaders(e);return this.send(t,"GET",{headers:r})},t.prototype.post=function(t,e,r){void 0===r&&(r={});var n=this.createHeaders(e);return n.set("Content-Type","application/json"),this.send(t,"POST",{headers:n,body:JSON.stringify(r)})},t.prototype.send=function(t,e,r){return P(this.prefix+t,S({method:e},r))},t.prototype.createHeaders=function(t){var e=new I;return e.set("Authorization","Virgil "+t),e.set("Virgil-Agent",this.virgilAgentValue),e},t}(),J=function(t){function e(r,n,i){void 0===n&&(n="VirgilError"),void 0===i&&(i=e);var o=t.call(this,r)||this;return Object.setPrototypeOf(o,i.prototype),o.name=n,o}return m(e,t),e}(Error);!function(t){t[t.AccessTokenExpired=20304]="AccessTokenExpired",t[t.Unknown=0]="Unknown"}(A||(A={}));var D=function(t){function e(r,n,i){var o=t.call(this,r,"VirgilHttpError",e)||this;return o.httpStatus=n,o.errorCode=i,o}return m(e,t),e}(J);function R(t){return T(this,void 0,void 0,(function(){var e;return x(this,(function(r){switch(r.label){case 0:return t.status>=400&&t.status<500?[4,t.json()]:[3,2];case 1:return e=r.sent(),[2,new D(e.message,t.status,e.code)];case 2:return[2,new D(t.statusText,t.status,0)]}}))}))}var B=function(t){return"/card/v5/"+t},N=function(t){return"/card/v5/actions/revoke/"+t},V=function(){function t(t,e){this.connection="string"==typeof t?new K(t,e):t||new K("https://api.virgilsecurity.com",e)}return t.prototype.searchCards=function(t,e){return T(this,void 0,void 0,(function(){var r,n;return x(this,(function(i){switch(i.label){case 0:return[4,this.connection.post("/card/v5/actions/search",e,{identities:t})];case 1:return(r=i.sent()).ok?[3,3]:[4,R(r)];case 2:throw i.sent();case 3:return[4,r.json()];case 4:return null===(n=i.sent())?[2,[]]:[2,n.map(C.fromJson)]}}))}))},t.prototype.getCard=function(t,e){return T(this,void 0,void 0,(function(){var r,n,i;return x(this,(function(o){switch(o.label){case 0:if(!t)throw new TypeError("`cardId` should not be empty");if(!e)throw new TypeError("`accessToken` should not be empty");return[4,this.connection.get(B(t),e)];case 1:return(r=o.sent()).ok?[3,3]:[4,R(r)];case 2:throw o.sent();case 3:return n="true"===r.headers.get("X-Virgil-Is-Superseeded"),[4,r.json()];case 4:return i=o.sent(),[2,{cardRaw:C.fromJson(i),isOutdated:n}]}}))}))},t.prototype.publishCard=function(t,e){return T(this,void 0,void 0,(function(){var r,n;return x(this,(function(i){switch(i.label){case 0:if(!t)throw new TypeError("`model` should not be empty");if(!e)throw new TypeError("`accessToken` should not be empty");return[4,this.connection.post("/card/v5",e,t)];case 1:return(r=i.sent()).ok?[3,3]:[4,R(r)];case 2:throw i.sent();case 3:return[4,r.json()];case 4:return n=i.sent(),[2,C.fromJson(n)]}}))}))},t.prototype.revokeCard=function(t,e){return T(this,void 0,void 0,(function(){var r;return x(this,(function(n){switch(n.label){case 0:if(!t)throw new TypeError("`cardId` should not be empty");if(!e)throw new TypeError("`accessToken` should not be empty");return[4,this.connection.post(N(t),e)];case 1:return(r=n.sent()).ok?[3,3]:[4,R(r)];case 2:throw n.sent();case 3:return[2]}}))}))},t}(),U=function(){function t(t){this.crypto=t}return t.prototype.sign=function(t){var e=this.prepareParams(t),r=e.model,n=e.signerPrivateKey,i=e.signer,o=e.extraSnapshot,s=null!=o?r.contentSnapshot+o:r.contentSnapshot,a=this.crypto.generateSignature({value:s,encoding:"utf8"},n);r.signatures.push({signer:i,signature:a.toString("base64"),snapshot:o})},t.prototype.prepareParams=function(t){var e,r=t.model,n=t.signerPrivateKey,i=t.extraFields,o=t.signer;o=o||"self",null!=i&&(e=JSON.stringify(i));var s={model:r,signerPrivateKey:n,signer:o,extraSnapshot:e};return this.validate(s),s},t.prototype.validate=function(t){var e=t.model,r=t.signerPrivateKey,n=t.signer;if(null==e)throw new Error("Model is empty");if(null==r)throw new Error("`signerPrivateKey` property is mandatory");if(null!=e.signatures&&e.signatures.some((function(t){return t.signer==n})))throw new Error("The model already has this signature.")},t}();function F(t,e,r){void 0===r&&(r=!1);var n=JSON.parse(e.contentSnapshot),i=e.signatures.map(H);return{id:L(t,e.contentSnapshot),publicKey:t.importPublicKey({value:n.public_key,encoding:"base64"}),contentSnapshot:e.contentSnapshot,identity:n.identity,version:n.version,createdAt:new Date(1e3*n.created_at),previousCardId:n.previous_card_id,signatures:i,isOutdated:r}}function q(t){for(var e=Object.create(null),r=0,n=t;r<n.length;r++){var i=n[r];e[i.id]=i}for(var o=0,s=t;o<s.length;o++){null!=(i=s[o]).previousCardId&&(null!=e[i.previousCardId]&&(e[i.previousCardId].isOutdated=!0,i.previousCard=e[i.previousCardId],delete e[i.previousCardId]))}return Object.keys(e).map((function(t){return e[t]}))}function L(t,e){return t.generateSha512({value:e,encoding:"utf8"}).slice(0,32).toString("hex")}function H(t){var e=t.snapshot,r=t.signature;return{signer:t.signer,signature:r,snapshot:e,extraFields:G(e)}}function G(t){if(t)try{return JSON.parse(t)}catch(t){}return{}}var M=function(t){function e(r){return t.call(this,r,"CardVerificationError",e)||this}return m(e,t),e}(J),W={getToken:function(){throw new Error("Please set `CardManager.accessTokenProvider` to be able to make requests.")}},z=function(t){return S(S({},t),{service:"cards"})},X=function(){function t(t){this.crypto=t.cardCrypto,this.client=new V(t.apiUrl,t.productInfo),this.modelSigner=new U(t.cardCrypto),this.signCallback=t.signCallback,this.retryOnUnauthorized=t.retryOnUnauthorized,this.cardVerifier=t.cardVerifier,this.accessTokenProvider=t.accessTokenProvider||W}return t.prototype.generateRawCard=function(t){var e,r,n,i,o,s=(e=this.crypto,n=(r=t).identity,i=r.publicKey,o={identity:n,previous_card_id:r.previousCardId,created_at:d(new Date),version:"5.0",public_key:e.exportPublicKey(i).toString("base64")},new C(JSON.stringify(o),[]));return this.modelSigner.sign({model:s,signerPrivateKey:t.privateKey,signer:"self",extraFields:t.extraFields}),s},t.prototype.publishCard=function(t){return T(this,void 0,void 0,(function(){var e,r,n;return x(this,(function(i){switch(i.label){case 0:return function(t,e){void 0===e&&(e=!1);h(null!=t,"Card parameters must be provided"),h(null!=t.privateKey,"Card's private key is required"),h(null!=t.publicKey,"Card's public key is required"),e&&h("string"==typeof t.identity&&""!==t.identity,"Card's identity is required")}(t),e={service:"cards",identity:t.identity,operation:"publish"},[4,this.accessTokenProvider.getToken(e)];case 1:return r=i.sent(),n=this.generateRawCard(Object.assign({},t,{identity:r.identity()})),[4,this.publishRawSignedModel(n,e,r)];case 2:return[2,i.sent()]}}))}))},t.prototype.publishRawCard=function(t){return T(this,void 0,void 0,(function(){var e,r,n;return x(this,(function(i){switch(i.label){case 0:return h(null!=t&&null!=t.contentSnapshot,"`rawCard` should not be empty"),e=JSON.parse(t.contentSnapshot),r=z({identity:e.identity,operation:"publish"}),[4,this.accessTokenProvider.getToken(r)];case 1:return n=i.sent(),[2,this.publishRawSignedModel(t,r,n)]}}))}))},t.prototype.getCard=function(t){return T(this,void 0,void 0,(function(){var e,r,n,i,o=this;return x(this,(function(s){switch(s.label){case 0:return e=z({operation:"get"}),[4,this.accessTokenProvider.getToken(e)];case 1:return r=s.sent(),[4,this.tryDo(e,r,(function(e){return T(o,void 0,void 0,(function(){return x(this,(function(r){switch(r.label){case 0:return[4,this.client.getCard(t,e.toString())];case 1:return[2,r.sent()]}}))}))}))];case 2:if(n=s.sent(),(i=F(this.crypto,n.cardRaw,n.isOutdated)).id!==t)throw new M("Received invalid card");return this.validateCards([i]),[2,i]}}))}))},t.prototype.searchCards=function(t){return T(this,void 0,void 0,(function(){var e,r,n,i,o,s,a=this;return x(this,(function(u){switch(u.label){case 0:if(!t)throw new TypeError("Argument `identities` is required");if(0===(e=Array.isArray(t)?t:[t]).length)throw new TypeError("Identities array must not be empty");return r=z({operation:"search"}),[4,this.accessTokenProvider.getToken(r)];case 1:return n=u.sent(),[4,this.tryDo(r,n,(function(t){return T(a,void 0,void 0,(function(){return x(this,(function(r){switch(r.label){case 0:return[4,this.client.searchCards(e,t.toString())];case 1:return[2,r.sent()]}}))}))}))];case 2:if(i=u.sent(),o=i.map((function(t){return F(a.crypto,t,!1)})),s=new Set(e),o.some((function(t){return!s.has(t.identity)})))throw new M("Received invalid cards");return this.validateCards(o),[2,q(o)]}}))}))},t.prototype.revokeCard=function(t){return T(this,void 0,void 0,(function(){var e,r,n=this;return x(this,(function(i){switch(i.label){case 0:if(!t)throw new TypeError("Argument `cardId` is required");return e=z({operation:"revoke"}),[4,this.accessTokenProvider.getToken(e)];case 1:return r=i.sent(),[4,this.tryDo(e,r,(function(e){return T(n,void 0,void 0,(function(){return x(this,(function(r){switch(r.label){case 0:return[4,this.client.revokeCard(t,e.toString())];case 1:return[2,r.sent()]}}))}))}))];case 2:return i.sent(),[2]}}))}))},t.prototype.importCard=function(t){var e=F(this.crypto,t);return this.validateCards([e]),e},t.prototype.importCardFromString=function(t){return h(Boolean(t),"`str` should not be empty"),this.importCard(C.fromString(t))},t.prototype.importCardFromJson=function(t){return h(Boolean(t),"`json` should not be empty"),this.importCard(C.fromJson(t))},t.prototype.exportCard=function(t){return function(t){return new C(t.contentSnapshot,t.signatures.slice())}(t)},t.prototype.exportCardAsString=function(t){return this.exportCard(t).toString()},t.prototype.exportCardAsJson=function(t){return this.exportCard(t).toJson()},t.prototype.publishRawSignedModel=function(t,e,r){return T(this,void 0,void 0,(function(){var n,i,o=this;return x(this,(function(s){switch(s.label){case 0:return null==this.signCallback?[3,2]:[4,this.signCallback(t)];case 1:t=s.sent(),s.label=2;case 2:return[4,this.tryDo(e,r,(function(e){return T(o,void 0,void 0,(function(){return x(this,(function(r){switch(r.label){case 0:return[4,this.client.publishCard(t,e.toString())];case 1:return[2,r.sent()]}}))}))}))];case 3:if(n=s.sent(),t.contentSnapshot!==n.contentSnapshot)throw new M("Received invalid card");return i=F(this.crypto,n),this.validateCards([i]),[2,i]}}))}))},t.prototype.tryDo=function(t,e,r){return T(this,void 0,void 0,(function(){var n;return x(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,6]),[4,r(e)];case 1:return[2,i.sent()];case 2:return(n=i.sent())instanceof D&&401===n.httpStatus&&n.errorCode===A.AccessTokenExpired&&this.retryOnUnauthorized?[4,this.accessTokenProvider.getToken(z({identity:t.identity,operation:t.operation,forceReload:!0}))]:[3,5];case 3:return e=i.sent(),[4,r(e)];case 4:return[2,i.sent()];case 5:throw n;case 6:return[2]}}))}))},t.prototype.validateCards=function(t){if(null!=this.cardVerifier)for(var e=0,r=t;e<r.length;e++){var n=r[e];if(!this.cardVerifier.verifyCard(n))throw new M("Validation errors have been detected")}},t}();var Y={verifySelfSignature:!0,verifyVirgilSignature:!0,whitelists:[]},Z=function(){function t(t,e){this.crypto=t;var r=S(S({},Y),e||{});this.verifySelfSignature=r.verifySelfSignature,this.verifyVirgilSignature=r.verifyVirgilSignature,this.whitelists=r.whitelists,this.virgilCardsPublicKey=t.importPublicKey({value:"MCowBQYDK2VwAyEAljOYGANYiVq1WbvVvoYIKtvZi2ji9bAhxyu6iV/LF8M=",encoding:"base64"})}return t.prototype.verifyCard=function(t){var e=this;if(this.selfValidationFailed(t))return!1;if(this.virgilValidationFailed(t))return!1;if(!this.whitelists||0===this.whitelists.length)return!0;for(var r=t.signatures.map((function(t){return t.signer})),n=0,i=this.whitelists;n<i.length;n++){var o=i[n];if(null==o||0===o.length)return!1;var s=o.filter((function(t){return-1!==r.indexOf(t.signer)}));if(0===s.length)return!1;if(!s.some((function(r){return e.validateSignerSignature(t,e.getPublicKey(r.publicKeyBase64),r.signer)})))return!1}return!0},t.prototype.selfValidationFailed=function(t){return this.verifySelfSignature&&!this.validateSignerSignature(t,t.publicKey,"self")},t.prototype.virgilValidationFailed=function(t){return this.verifyVirgilSignature&&!this.validateSignerSignature(t,this.virgilCardsPublicKey,"virgil")},t.prototype.getPublicKey=function(t){return this.crypto.importPublicKey({value:t,encoding:"base64"})},t.prototype.validateSignerSignature=function(t,e,r){var n=t.signatures.find((function(t){return t.signer===r}));if(null==n)return!1;var i=null==n.snapshot?t.contentSnapshot:t.contentSnapshot+n.snapshot;return this.crypto.verifySignature({value:i,encoding:"utf8"},{value:n.signature,encoding:"base64"},e)},t}(),Q=r((function(t,e){!function(t){var e,r,n,i=String.fromCharCode;function o(t){for(var e,r,n=[],i=0,o=t.length;i<o;)(e=t.charCodeAt(i++))>=55296&&e<=56319&&i<o?56320==(64512&(r=t.charCodeAt(i++)))?n.push(((1023&e)<<10)+(1023&r)+65536):(n.push(e),i--):n.push(e);return n}function s(t){if(t>=55296&&t<=57343)throw Error("Lone surrogate U+"+t.toString(16).toUpperCase()+" is not a scalar value")}function a(t,e){return i(t>>e&63|128)}function u(t){if(0==(4294967168&t))return i(t);var e="";return 0==(4294965248&t)?e=i(t>>6&31|192):0==(4294901760&t)?(s(t),e=i(t>>12&15|224),e+=a(t,6)):0==(4292870144&t)&&(e=i(t>>18&7|240),e+=a(t,12),e+=a(t,6)),e+=i(63&t|128)}function c(){if(n>=r)throw Error("Invalid byte index");var t=255&e[n];if(n++,128==(192&t))return 63&t;throw Error("Invalid continuation byte")}function d(){var t,i;if(n>r)throw Error("Invalid byte index");if(n==r)return!1;if(t=255&e[n],n++,0==(128&t))return t;if(192==(224&t)){if((i=(31&t)<<6|c())>=128)return i;throw Error("Invalid continuation byte")}if(224==(240&t)){if((i=(15&t)<<12|c()<<6|c())>=2048)return s(i),i;throw Error("Invalid continuation byte")}if(240==(248&t)&&(i=(7&t)<<18|c()<<12|c()<<6|c())>=65536&&i<=1114111)return i;throw Error("Invalid UTF-8 detected")}t.version="3.0.0",t.encode=function(t){for(var e=o(t),r=e.length,n=-1,i="";++n<r;)i+=u(e[n]);return i},t.decode=function(t){e=o(t),r=e.length,n=0;for(var s,a=[];!1!==(s=d());)a.push(s);return function(t){for(var e,r=t.length,n=-1,o="";++n<r;)(e=t[n])>65535&&(o+=i((e-=65536)>>>10&1023|55296),e=56320|1023&e),o+=i(e);return o}(a)}}(e)}));var $=function(t){function e(r){return t.call(this,"Storage entry "+(r?"with key "+name:"with the given key")+"already exists","StorageEntryAlreadyExistsError",e)||this}return m(e,t),e}(J),tt={},et=function(){function t(t){var e=this;if(this._initStorage=function(){var t={db:null,name:e._defaultConfig.name,storeName:e._defaultConfig.storeName,version:e._defaultConfig.version},r=tt[t.name];return r||(r={db:null,dbReady:null,deferredOperations:[]},tt[t.name]=r),Promise.resolve().then((function(){return t.db=r.db,it(t)})).then((function(r){return t.db=r,st(t,e._defaultConfig.version)?ot(t):r})).then((function(n){t.db=r.db=n,e._dbInfo=t}))},this.ready=function(){return e._ready.then((function(){var t=tt[e._dbInfo.name];if(t&&t.dbReady)return t.dbReady}))},!function(){try{return"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(t){return!1}}())throw new Error("Cannot use IndexedDbStorageAdapter. indexedDb is not supported");this._defaultConfig={name:t.name,version:1,storeName:"keyvaluepairs"},this._ready=this._initStorage()}return t.prototype.store=function(t,e){var r=this;return t=ct(t),new Promise((function(n,i){r.ready().then((function(){ut(r._dbInfo,"readwrite",(function(o,s){if(o)return i(o);try{var a=s.objectStore(r._dbInfo.storeName).add(e,t);s.oncomplete=function(){n()},s.onabort=s.onerror=function(){var e=a.error?a.error:a.transaction.error;e&&"ConstraintError"===e.name&&i(new $(t)),i(e)}}catch(t){i(t)}}))})).catch(i)}))},t.prototype.load=function(t){var e=this;return t=ct(t),new Promise((function(r,n){e.ready().then((function(){ut(e._dbInfo,"readonly",(function(i,o){if(i)return n(i);try{var s=o.objectStore(e._dbInfo.storeName).get(t);s.onsuccess=function(){if(null==s.result)return r(null);r(dt(s.result))},s.onerror=function(){n(s.error)}}catch(t){n(t)}}))})).catch(n)}))},t.prototype.exists=function(t){var e=this;return t=ct(t),new Promise((function(r,n){e.ready().then((function(){ut(e._dbInfo,"readonly",(function(i,o){if(i)return n(i);try{var s=o.objectStore(e._dbInfo.storeName).openCursor(t);s.onsuccess=function(){var t=s.result;r(null!==t)},s.onerror=function(){n(s.error)}}catch(t){n(t)}}))})).catch(n)}))},t.prototype.remove=function(t){var e=this;return t=ct(t),new Promise((function(r,n){e.ready().then((function(){ut(e._dbInfo,"readwrite",(function(i,o){if(i)return n(i);try{var s,a=o.objectStore(e._dbInfo.storeName),u=a.count(t);u.onsuccess=function(){if(0===u.result)return r(!1);(s=a.delete(t)).onsuccess=function(){return r(!0)}},o.onabort=o.onerror=function(){var t=s||u,e=t.error?t.error:t.transaction.error;n(e)}}catch(t){n(t)}}))})).catch(n)}))},t.prototype.update=function(t,e){var r=this;return t=ct(t),new Promise((function(n,i){r.ready().then((function(){ut(r._dbInfo,"readwrite",(function(o,s){if(o)return i(o);try{var a=s.objectStore(r._dbInfo.storeName).put(e,t);a.onsuccess=function(){n()},a.onerror=function(){i(a.error)}}catch(t){i(t)}}))})).catch(i)}))},t.prototype.clear=function(){var t=this;return new Promise((function(e,r){t.ready().then((function(){ut(t._dbInfo,"readwrite",(function(n,i){if(n)return r(n);try{var o=i.objectStore(t._dbInfo.storeName).clear();i.oncomplete=function(){return e()},i.onabort=i.onerror=function(){var t=o.error?o.error:o.transaction.error;r(t)}}catch(t){r(t)}}))})).catch(r)}))},t.prototype.list=function(){var t=this;return new Promise((function(e,r){t.ready().then((function(){ut(t._dbInfo,"readonly",(function(n,i){if(n)return r(n);try{var o=i.objectStore(t._dbInfo.storeName).openCursor(),s=[];o.onsuccess=function(){var t=o.result;t?(s.push(dt(t.value)),t.continue()):e(s)},o.onerror=function(){r(o.error)}}catch(t){r(t)}}))})).catch(r)}))},t}();function rt(t){var e=tt[t.name],r={};r.promise=new Promise((function(t,e){r.resolve=t,r.reject=e})),e.deferredOperations.push(r),e.dbReady?e.dbReady=e.dbReady.then((function(){return r.promise})):e.dbReady=r.promise}function nt(t,e){return new Promise((function(r,n){if(tt[t.name]=tt[t.name]||{db:null,dbReady:null,deferredOperations:[]},t.db){if(!e)return r(t.db);rt(t),t.db.close()}var i=[t.name];e&&i.push(String(t.version));var o=indexedDB.open.apply(indexedDB,i);e&&(o.onupgradeneeded=function(e){var r=o.result;try{r.createObjectStore(t.storeName)}catch(r){if("ConstraintError"!==r.name)throw r;console.warn('The database "'+t.name+'" has been upgraded from version '+e.oldVersion+" to version "+e.newVersion+', but the storage "'+t.storeName+'" already exists.')}}),o.onerror=function(t){t.preventDefault(),n(o.error)},o.onsuccess=function(){r(o.result),function(t){var e=tt[t.name].deferredOperations.pop();if(e)e.resolve(),e.promise}(t)}}))}function it(t){return nt(t,!1)}function ot(t){return nt(t,!0)}function st(t,e){if(!t.db)return!0;var r=!t.db.objectStoreNames.contains(t.storeName),n=t.version<t.db.version,i=t.version>t.db.version;if(n&&(t.version!==e&&console.warn('The database "'+t.name+"\" can't be downgraded from version "+t.db.version+" to version "+t.version+"."),t.version=t.db.version),i||r){if(r){var o=t.db.version+1;o>t.version&&(t.version=o)}return!0}return!1}function at(t){rt(t);var e=tt[t.name];return t.db=null,it(t).then((function(e){return t.db=e,st(t)?ot(t):e})).then((function(r){t.db=e.db=r})).catch((function(e){throw function(t,e){var r=tt[t.name].deferredOperations.pop();if(r)r.reject(e),r.promise}(t,e),e}))}function ut(t,e,r,n){void 0===n&&(n=1);try{var i=t.db.transaction(t.storeName,e);r(null,i)}catch(i){n>0&&(!t.db||"InvalidStateError"===i.name||"NotFoundError"===i.name)&&Promise.resolve().then((function(){if(!t.db||"NotFoundError"===i.name&&!t.db.objectStoreNames.contains(t.storeName)&&t.version<=t.db.version)return t.db&&(t.version=t.db.version+1),ot(t)})).then((function(){return at(t).then((function(){ut(t,e,r,n-1)}))})).catch(r),r(i)}}function ct(t){return"string"!=typeof t&&(console.warn(t+" used as a key, but it is not a string."),t=String(t)),t}function dt(t){if(t instanceof ArrayBuffer){var e=new Uint8Array(t);return Q.decode(String.fromCharCode.apply(null,e))}if("string"==typeof t)return t;throw new TypeError("Unknown value format")}var ft=function(t){function e(r){return void 0===r&&(r="Private key with same name already exists"),t.call(this,r,"PrivateKeyExistsError",e)||this}return m(e,t),e}(J),ht={dir:".virgil_keys",name:"VirgilKeys"},pt=function(){function t(t){void 0===t&&(t={}),console.log("Warning! `KeyStorage` is deprecated. Use `PrivateKeyStorage` instead."),this.adapter=function(t){if("string"==typeof t)return new et({dir:t,name:t});var e=t.adapter,r=E(t,["adapter"]);if(null!=e)return e;return new et(S(S({},ht),r))}(t)}return t.prototype.exists=function(t){return lt(t),this.adapter.exists(t)},t.prototype.load=function(t){return lt(t),this.adapter.load(t)},t.prototype.remove=function(t){return lt(t),this.adapter.remove(t)},t.prototype.save=function(t,e){return lt(t),this.adapter.store(t,e).catch((function(t){return t&&"EEXIST"===t.code?Promise.reject(new ft):Promise.reject(t)}))},t}();function lt(t){if(!t)throw new TypeError("Argument `name` is required.")}var yt=function(t){function e(r){return void 0===r&&(r="Loaded key entry was in invalid format."),t.call(this,r,"InvalidKeyEntryError",e)||this}return m(e,t),e}(J),vt=function(t){function e(r){return t.call(this,"Key entry "+(r?"named "+r:"with same name")+"already exists","KeyEntryAlreadyExistsError",e)||this}return m(e,t),e}(J),gt=function(t){function e(r){return t.call(this,"Key entry "+(r?"named "+r:"with the given name")+" does not exist.","KeyEntryDoesNotExistError",e)||this}return m(e,t),e}(J),wt={dir:".virgil_key_entries",name:"VirgilKeyEntries"},bt=function(){function t(t){void 0===t&&(t={}),this.adapter=function(t){if("string"==typeof t)return new et({dir:t,name:t});var e=t.adapter,r=E(t,["adapter"]);if(null!=e)return e;return new et(S(S({},wt),r))}(t)}return t.prototype.exists=function(t){return Tt(t),this.adapter.exists(t)},t.prototype.load=function(t){return Tt(t),this.adapter.load(t).then((function(t){return null==t?null:St(t)}))},t.prototype.remove=function(t){return Tt(t),this.adapter.remove(t)},t.prototype.save=function(t){var e=t.name,r=t.value,n=t.meta;xt(e),At(r);var i={name:e,value:r,meta:n,creationDate:new Date,modificationDate:new Date};return this.adapter.store(e,mt(i)).then((function(){return i})).catch((function(t){if(t&&"StorageEntryAlreadyExistsError"===t.name)throw new vt(e);throw t}))},t.prototype.list=function(){return this.adapter.list().then((function(t){return t.map((function(t){return St(t)}))}))},t.prototype.update=function(t){var e=this,r=t.name,n=t.value,i=t.meta;if(xt(r),!n&&!i)throw new TypeError("Invalid argument. Either `value` or `meta` property is required.");return this.adapter.load(r).then((function(t){if(null===t)throw new gt(r);var o=St(t),s=Object.assign(o,{value:n||o.value,meta:i||o.meta,modificationDate:new Date});return e.adapter.update(r,mt(s)).then((function(){return s}))}))},t.prototype.clear=function(){return this.adapter.clear()},t}();function mt(t){return JSON.stringify(t)}function St(t){try{return JSON.parse(t,(function(t,e){return"creationDate"===t||"modificationDate"===t?new Date(e):e}))}catch(t){throw new yt}}var Et=function(t){return function(e){if(!e)throw new TypeError("Invalid argument. Property "+t+" is required")}},Tt=function(t){return function(e){if(!e)throw new TypeError("Argument '"+t+"' is required.")}}("name"),xt=Et("name"),At=Et("value"),Ct=function(){function t(t,e){void 0===e&&(e=new bt),this.privateKeyExporter=t,this.keyEntryStorage=e}return t.prototype.store=function(t,e,r){return T(this,void 0,void 0,(function(){var n,i;return x(this,(function(o){switch(o.label){case 0:n=this.privateKeyExporter.exportPrivateKey(e),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.keyEntryStorage.save({name:t,value:n.toString("base64"),meta:r})];case 2:return o.sent(),[3,4];case 3:if((i=o.sent())&&"KeyEntryAlreadyExistsError"===i.name)throw new ft("Private key with the name "+t+" already exists.");throw i;case 4:return[2]}}))}))},t.prototype.load=function(t){return T(this,void 0,void 0,(function(){var e;return x(this,(function(r){switch(r.label){case 0:return[4,this.keyEntryStorage.load(t)];case 1:return null===(e=r.sent())?[2,null]:[2,{privateKey:this.privateKeyExporter.importPrivateKey(e.value),meta:e.meta}]}}))}))},t.prototype.delete=function(t){return T(this,void 0,void 0,(function(){return x(this,(function(e){switch(e.label){case 0:return[4,this.keyEntryStorage.remove(t)];case 1:return e.sent(),[2]}}))}))},t}();t.CachingJwtProvider=y,t.CallbackJwtProvider=v,t.CardManager=X,t.ConstAccessTokenProvider=g,t.DefaultStorageAdapter=et,t.GeneratorJwtProvider=w,t.InvalidKeyEntryError=yt,t.Jwt=f,t.JwtGenerator=p,t.JwtVerifier=l,t.KeyEntryAlreadyExistsError=vt,t.KeyEntryDoesNotExistError=gt,t.KeyEntryStorage=bt,t.KeyStorage=pt,t.ModelSigner=U,t.PrivateKeyStorage=Ct,t.RawSignedModel=C,t.StorageEntryAlreadyExistsError=$,t.VirgilAgent=j,t.VirgilCardVerifier=Z,Object.defineProperty(t,"__esModule",{value:!0})}));
